---
apiVersion: source.toolkit.fluxcd.io/v1beta2
kind: OCIRepository
metadata:
  name: firefly-iii-importer-chart
  namespace: home-network
spec:
  interval: 24h
  url: oci://harbor.services.home.yrf.me/chartproxy/firefly-iii.github.io/kubernetes/importer
  ref:
    tag: 1.4.1
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: firefly-iii-importer
  namespace: home-network
spec:
  releaseName: firefly-iii-importer
  chartRef:
    kind: OCIRepository
    name: firefly-iii-importer-chart
  interval: 15m
  postRenderers:
  - kustomize:
      patches:
      - patch: |
          - op: "add"
            path: "/spec/template/spec/runtimeClassName"
            value: "gvisor"
        target:
          kind: Deployment
      - patch: |
          - op: "add"
            path: "/spec/jobTemplate/spec/template/spec/runtimeClassName"
            value: "gvisor"
        target:
          kind: CronJob
      - patch: |
          - op: "add"
            path: "/metadata/labels/external-dns"
            value: "local-pdns"
        target:
          kind: Ingress
  values:
    image:
      repository: fireflyiii/data-importer
      tag: version-1.6.2
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
          - matchExpressions:
            - key: location
              operator: In
              values:
              - "rfhome"
          - matchExpressions:
            - key: node-group
              operator: NotIn
              values:
              - "pi4"
    config:
      env:
        TZ: Asia/Kuala_Lumpur
    fireflyiii:
      url: http://firefly-iii
      vanityUrl: https://firefly-iii.services.home.yrf.me
    ingress:
      enabled: true
      className: traefik-traefik
      annotations:
        # traefik.ingress.kubernetes.io/router.middlewares: home-network-ak-outpost-authentik-embedded-outpost@kubernetescrd
        traefik.ingress.kubernetes.io/router.entrypoints: websecure
      hosts:
      - firefly-iii-importer.services.home.yrf.me
      tls:
      - secretName: services-wildcard-cert
        hosts:
        - firefly-iii-importer.services.home.yrf.me
