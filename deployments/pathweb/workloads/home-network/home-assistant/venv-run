#!/usr/bin/with-contenv bashio
# ==============================================================================
# Start Home Assistant service
# ==============================================================================

cd /config || bashio::exit.nok "Can't find config folder!"

# Enable mimalloc for Home Assistant Core, unless disabled
if [[ -z "${DISABLE_JEMALLOC+x}" ]]; then
  export LD_PRELOAD="/usr/local/lib/libjemalloc.so.2"
  export MALLOC_CONF="background_thread:true,metadata_thp:auto,dirty_decay_ms:20000,muzzy_decay_ms:20000"
fi

pyenv_hash=$(uv pip list | sha256sum | cut -d " " -f 1 )
arch=$(uname -m)
venv_path="/venv/$pyenv_hash/$arch"
unset UV_SYSTEM_PYTHON
mkdir -p /venv/
uv venv --system-site-packages --link-mode=symlink --prompt "${pyenv_hash:0:8}-$arch" $venv_path
ln -fs $venv_path /venv/current_venv
source /venv/current_venv/bin/activate
uv pip install uv
echo $arch > /venv/LASTARCH
echo $pyenv_hash > /venv/LAST_PYENV_HASH

exec python3 -m homeassistant --config /config
