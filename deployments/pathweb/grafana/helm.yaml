---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: grafana
  namespace: flux-system
spec:
  releaseName: grafana
  chart:
    spec:
      chart: grafana
      version: 8.2.21
      sourceRef:
        kind: HelmRepository
        name: bitnami
  interval: 15m
  targetNamespace: home-network
  values:
    datasources:
      secretDefinition:
        apiVersion: 1
        datasources:
          - name: Thanos
            type: prometheus
            url: http://thanos-query-frontend.monitoring:9090
            isDefault: true
    ingress:
      enabled: true
      pathType: Prefix
      hostname: grafana.services.home.yrf.me
      tls: false
      extraTls:
      - hosts:
        - grafana.services.home.yrf.me
        secretName: services-wildcard-cert
      ingressClassName: traefik-traefik
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
        namespace: monitoring
      prometheusRule:
        enabled: false
        namespace: monitoring
        rules:
          - alert: Grafana-Down
            annotations:
              message: "Grafana instance is down"
              summary: Grafana instance is down
            expr: absent(up{job="grafana"} == 1)
            labels:
              severity: warning
              service: grafana
            for: 5m